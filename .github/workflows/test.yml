name: Test FCM Application

on:
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“š Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ” Lint Check
      run: |
        echo "Running lint checks..."
        
        # HTML ìœ íš¨ì„± ê²€ì‚¬
        if command -v tidy &> /dev/null; then
          echo "Checking HTML validity..."
          tidy -q -e index.html || echo "HTML validation completed with warnings"
        fi
        
        # JavaScript ë¬¸ë²• ê²€ì‚¬
        echo "Checking JavaScript syntax..."
        node -c fcm-manager.js
        node -c firebase-messaging-sw.js
        
        # JSON ìœ íš¨ì„± ê²€ì‚¬
        echo "Checking JSON files..."
        cat manifest.json | jq . > /dev/null
        cat firebase.json | jq . > /dev/null
        cat package.json | jq . > /dev/null
        
        echo "âœ… All lint checks passed"
        
    - name: ðŸ”’ Security Check
      run: |
        echo "Running security checks..."
        
        # ë¯¼ê°í•œ ì •ë³´ ì²´í¬
        if grep -r "password\|secret\|private" --include="*.js" --include="*.html" --include="*.json" . --exclude-dir=node_modules; then
          echo "âš ï¸ Warning: Potential sensitive information found"
        else
          echo "âœ… No sensitive information detected"
        fi
        
        # FCM ì„¤ì • ê²€ì¦
        if grep -q "firebase.initializeApp" firebase-messaging-sw.js && grep -q "firebase.initializeApp" fcm-manager.js; then
          echo "âœ… Firebase initialization found"
        else
          echo "âŒ Firebase initialization missing"
          exit 1
        fi
        
    - name: ðŸ§ª Unit Tests
      run: |
        echo "Running unit tests..."
        
        # Service Worker ë“±ë¡ í…ŒìŠ¤íŠ¸
        if grep -q "firebase-messaging-sw.js" index.html; then
          echo "âœ… Service Worker registration found"
        else
          echo "âŒ Service Worker registration missing"
          exit 1
        fi
        
        # PWA ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ë§í¬ í…ŒìŠ¤íŠ¸
        if grep -q "manifest.json" index.html; then
          echo "âœ… PWA manifest link found"
        else
          echo "âŒ PWA manifest link missing"
          exit 1
        fi
        
        # FCM ê´€ë¦¬ìž ìŠ¤í¬ë¦½íŠ¸ í…ŒìŠ¤íŠ¸
        if grep -q "fcm-manager.js" index.html; then
          echo "âœ… FCM manager script found"
        else
          echo "âŒ FCM manager script missing"
          exit 1
        fi
        
        echo "âœ… All unit tests passed"
        
    - name: ðŸŒ Browser Compatibility Test
      run: |
        echo "Running browser compatibility checks..."
        
        # Service Worker ì§€ì› ì²´í¬
        if grep -q "serviceWorker.*in.*navigator" fcm-manager.js; then
          echo "âœ… Service Worker compatibility check found"
        else
          echo "âš ï¸ Service Worker compatibility check missing"
        fi
        
        # Notification API ì§€ì› ì²´í¬
        if grep -q "Notification.*in.*window" fcm-manager.js; then
          echo "âœ… Notification API compatibility check found"
        else
          echo "âš ï¸ Notification API compatibility check missing"
        fi
        
        echo "âœ… Browser compatibility checks completed"
        
    - name: ðŸ“Š Code Quality Report
      run: |
        echo "## ðŸ“Š Code Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # íŒŒì¼ í†µê³„
        echo "### ðŸ“ File Statistics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| File | Lines | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|------|" >> $GITHUB_STEP_SUMMARY
        
        for file in *.js *.html *.json; do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file")
            size=$(du -h "$file" | cut -f1)
            echo "| $file | $lines | $size |" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ì½”ë“œ ë³µìž¡ë„ (ê°„ë‹¨í•œ ë©”íŠ¸ë¦­)
        echo "### ðŸ§® Code Metrics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        total_js_lines=$(find . -name "*.js" -not -path "./node_modules/*" -exec wc -l {} + | tail -1 | cut -d' ' -f1)
        total_functions=$(grep -r "function\|=>" . --include="*.js" --exclude-dir=node_modules | wc -l)
        
        echo "- **Total JavaScript Lines**: $total_js_lines" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Functions**: $total_functions" >> $GITHUB_STEP_SUMMARY
        echo "- **Average Lines per Function**: $((total_js_lines / (total_functions + 1)))" >> $GITHUB_STEP_SUMMARY
