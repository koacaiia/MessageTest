name: Deploy FCM Application

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“š Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        npm init -y
        npm install --save-dev http-server
        npm install --save-dev firebase-tools
        
    - name: ğŸ”§ Configure Firebase
      run: |
        echo "Configuring Firebase..."
        # Firebase ì„¤ì • íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
        if [ ! -f "firebase.json" ]; then
          echo "Creating Firebase configuration..."
          cat > firebase.json << EOF
        {
          "hosting": {
            "public": ".",
            "ignore": [
              "firebase.json",
              "**/.*",
              "**/node_modules/**",
              "**/*.md",
              ".github/**"
            ],
            "rewrites": [
              {
                "source": "**",
                "destination": "/index.html"
              }
            ],
            "headers": [
              {
                "source": "/firebase-messaging-sw.js",
                "headers": [
                  {
                    "key": "Service-Worker-Allowed",
                    "value": "/"
                  }
                ]
              }
            ]
          }
        }
        EOF
        fi
        
    - name: ğŸ” Validate HTML
      run: |
        echo "Validating HTML structure..."
        if [ -f "index.html" ]; then
          echo "âœ… index.html found"
        else
          echo "âŒ index.html not found"
          exit 1
        fi
        
        if [ -f "firebase-messaging-sw.js" ]; then
          echo "âœ… Service Worker found"
        else
          echo "âŒ Service Worker not found"
          exit 1
        fi
        
    - name: ğŸ§ª Test application
      run: |
        echo "Testing application..."
        # ê°„ë‹¨í•œ HTTP ì„œë²„ë¡œ í…ŒìŠ¤íŠ¸
        npx http-server . -p 8080 &
        SERVER_PID=$!
        sleep 5
        
        # í—¬ìŠ¤ì²´í¬
        if curl -f http://localhost:8080; then
          echo "âœ… Application is running correctly"
        else
          echo "âŒ Application failed to start"
          kill $SERVER_PID
          exit 1
        fi
        
        kill $SERVER_PID
        
    - name: ğŸ—ï¸ Build application
      run: |
        echo "Building application..."
        mkdir -p dist
        
        # ì •ì  íŒŒì¼ë“¤ì„ dist í´ë”ë¡œ ë³µì‚¬
        cp index.html dist/
        cp firebase-messaging-sw.js dist/
        cp fcm-manager.js dist/
        cp manifest.json dist/
        
        # Firebase ë¡œê³  ì´ë¯¸ì§€ ìƒì„± (SVGë¡œ ê°„ë‹¨íˆ)
        mkdir -p dist/icons
        cat > dist/firebase-logo.png << 'EOF'
        # Firebase ë¡œê³  ëŒ€ì‹  ì‚¬ìš©í•  ê¸°ë³¸ ì•„ì´ì½˜ì„ ì—¬ê¸°ì— ì¶”ê°€
        # ì‹¤ì œ í”„ë¡œì íŠ¸ì—ì„œëŠ” Firebase ë¡œê³  ì´ë¯¸ì§€ íŒŒì¼ì„ ì‚¬ìš©
        EOF
        
        echo "âœ… Build completed"
        
    - name: ğŸš€ Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        
    - name: ğŸ”¥ Deploy to Firebase Hosting
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        if [ -n "$FIREBASE_TOKEN" ]; then
          echo "Deploying to Firebase Hosting..."
          npx firebase deploy --token "$FIREBASE_TOKEN"
        else
          echo "Firebase token not found. Skipping Firebase deployment."
          echo "To enable Firebase deployment, add FIREBASE_TOKEN to repository secrets."
        fi
        
    - name: ğŸ“Š Deployment Summary
      run: |
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Successfully Deployed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
        echo "- **GitHub Pages**: Available at https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Firebase Hosting**: $([ -n "${{ secrets.FIREBASE_TOKEN }}" ] && echo "âœ… Deployed" || echo "âš ï¸ Skipped (no token)")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ Features Included" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”” Firebase Cloud Messaging (FCM)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“± Progressive Web App (PWA)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”§ Service Worker for background notifications" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ¨ Modern responsive UI" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ§ª Notification testing interface" >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸ” Security Scan
      run: |
        echo "Running security checks..."
        
        # FCM ì„¤ì • íŒŒì¼ì—ì„œ ë¯¼ê°í•œ ì •ë³´ ì²´í¬
        if grep -q "your-api-key\|your-project\|your-sender-id\|your-app-id\|your-vapid-key" dist/*.js dist/*.html; then
          echo "âš ï¸ Warning: Default Firebase configuration detected"
          echo "Please update Firebase configuration with your actual project settings"
        else
          echo "âœ… No default configuration found"
        fi
        
        # ë³´ì•ˆ í—¤ë” ì²´í¬
        echo "âœ… Security checks completed"
